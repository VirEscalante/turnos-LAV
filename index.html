<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turnos - Limpieza Alto Valle</title>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales/es.js'></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #calendar {
      max-width: 700px;
      margin: 0 auto;
    }
    form {
      display: none;
      flex-direction: column;
      max-width: 600px;
      margin: 20px auto;
    }
    label {
      margin-top: 10px;
    }
    #pagoSeña {
      margin: 20px auto;
      display: block;
    }
    #botonWhatsapp {
      display: none;
      margin-top: 20px;
    }
    #otroServicioContainer {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Reservá tu turno</h1>
  <div id='calendar'></div>

  <div id="pagoSeña">
    <a href="https://www.mercadopago.com.ar/" target="_blank">
      <button>Abonar seña $5.000</button>
    </a>
  </div>

  <form id="reservaForm">
    <input type="hidden" name="fecha" id="fechaSeleccionada" required>

    <label>Nombre:
      <input type="text" name="nombre" required>
    </label>

    <label>Teléfono:
      <input type="tel" name="telefono" required>
    </label>

    <label>Dirección:
      <input type="text" name="direccion" required>
    </label>

    <label>Ciudad:
      <input type="text" name="ciudad" required>
    </label>

    <fieldset>
      <legend>Servicios</legend>
      <label><input type="checkbox" name="servicios" value="Lavado de alfombra"> Lavado de alfombra</label>
      <label><input type="checkbox" name="servicios" value="Limpieza de colchón"> Limpieza de colchón</label>
      <label><input type="checkbox" name="servicios" value="Sillones"> Sillones</label>
      <label><input type="checkbox" id="otroCheckbox" value="Otro"> Otro</label>
    </fieldset>

    <div id="otroServicioContainer">
      <label>Especificar otro servicio:
        <input type="text" id="otroServicio" name="otroServicio">
      </label>
      <label>Detalle del servicio:
        <textarea name="detalle" id="detalleServicio"></textarea>
      </label>
    </div>

    <button type="submit" id="botonWhatsapp">Enviar por WhatsApp</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarEl = document.getElementById('calendar');
      const form = document.getElementById('reservaForm');
      const fechaInput = document.getElementById('fechaSeleccionada');
      const pagoDiv = document.getElementById('pagoSeña');
      const botonWhatsapp = document.getElementById('botonWhatsapp');
      const otroCheckbox = document.getElementById('otroCheckbox');
      const otroServicioContainer = document.getElementById('otroServicioContainer');
      const otroServicioInput = document.getElementById('otroServicio');

      if (new URLSearchParams(window.location.search).get("pago") === "ok") {
        form.style.display = 'flex';
        pagoDiv.style.display = 'none';
        botonWhatsapp.style.display = 'block';
      }

      otroCheckbox.addEventListener('change', () => {
        if (otroCheckbox.checked) {
          otroServicioContainer.style.display = 'block';
          document.getElementById('detalleServicio').required = true;
        } else {
          otroServicioInput.value = '';
          otroServicioContainer.style.display = 'none';
          document.getElementById('detalleServicio').required = false;
        }
      });

      const today = new Date();
      const minVisibleDate = new Date(today.getFullYear(), today.getMonth(), 21);
      const maxVisibleDate = new Date(today.getFullYear(), today.getMonth() + 2, 1);

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        selectable: true,
        validRange: {
          start: minVisibleDate,
          end: maxVisibleDate
        },
        events: async function (fetchInfo, successCallback, failureCallback) {
          try {
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/84ead65e555e180b177d45c8dc49cc893cdb6e0d5806d770ec849fabb31585bb@group.calendar.google.com/events?key=AIzaSyDQVz9Q1OxF12kjtW04UNigTLd9YEd4Jy8&timeMin=${fetchInfo.startStr}&timeMax=${fetchInfo.endStr}&singleEvents=true&orderBy=startTime`);
            const data = await response.json();
            const reservados = data.items.map(event => event.start.dateTime || event.start.date);

            const disponibles = [];
            const startDate = new Date(fetchInfo.start);
            const endDate = new Date(fetchInfo.end);
            const horasDisponibles = ['08:00', '15:00'];

            for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
              if (d.getDay() === 0 || d.getDay() === 6) continue;
              const dateStr = d.toISOString().split('T')[0];

              for (const hora of horasDisponibles) {
                const fechaHora = `${dateStr}T${hora}:00`;
                const yaReservado = reservados.some(ev => ev.startsWith(dateStr) && ev.includes(hora));
                if (!yaReservado) {
                  disponibles.push({
                    title: 'Disponible',
                    start: fechaHora,
                    allDay: false,
                    color: '#4caf50'
                  });
                }
              }
            }

            successCallback(disponibles);
          } catch (error) {
            console.error('Error al cargar eventos', error);
            failureCallback(error);
          }
        },
        select: function (info) {
          if (info.start < minVisibleDate) return;
          const fecha = info.startStr;
          fechaInput.value = fecha;
          form.style.display = 'flex';
          window.scrollTo({ top: form.offsetTop, behavior: 'smooth' });
        }
      });

      calendar.render();

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        const datos = new FormData(form);
        const serviciosSeleccionados = Array.from(form.querySelectorAll('input[name="servicios"]:checked')).map(cb => cb.value).join(', ');

        const mensaje = `Hola! Quiero reservar un turno el ${datos.get('fecha')}
Nombre: ${datos.get('nombre')}
Teléfono: ${datos.get('telefono')}
Dirección: ${datos.get('direccion')}
Ciudad: ${datos.get('ciudad')}
Servicios: ${serviciosSeleccionados}
Otro servicio: ${datos.get('otroServicio') || 'N/A'}
Detalle: ${datos.get('detalle') || 'N/A'}`;

        const url = `https://wa.me/5492984655610?text=${encodeURIComponent(mensaje)}`;
        window.open(url, '_blank');
      });
    });
  </script>

</body>
</html>
